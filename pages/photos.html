<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Share and view photos from James & Oliver's wedding celebration">
  <meta name="theme-color" content="#F9F7F3">
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">

  
  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://widget.cloudinary.com https://res.cloudinary.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://res.cloudinary.com https://www.google-analytics.com; frame-src 'self' https://widget.cloudinary.com https://upload-widget.cloudinary.com;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()">
  
  <title>James & Oliver – Gallery</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@600&display=swap"
    rel="stylesheet"
  />
  <link rel="icon" href="../assets/images/favicon.png" type="image/png" />
  
  <!-- Google Analytics - Replace GA_MEASUREMENT_ID with your actual ID -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'GA_MEASUREMENT_ID', {
      page_title: 'Photo Gallery',
      custom_map: {
        'custom_parameter_1': 'photo_upload',
        'custom_parameter_2': 'gallery_view'
      }
    });
  </script>

  <!-- LightGallery CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lightgallery-bundle.min.css"
    onerror="console.warn('LightGallery CSS failed to load from CDN')"
  />

  <style>
    :root {
      --bg: #F9F7F3;
      --text: #3D4739;
      --accent: #C9486A;
      --green: #9DA79D;
      --bg-alt: #FFFFFF;
    }
    
    body.dark-mode {
      --bg: #1e1e1e;
      --text: #f0f0f0;
      --accent: #ff7f50;
      --green: #6b8e23;
      --bg-alt: #2a2a2a;
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }

    /* Focus styles for accessibility */
    button:focus,
    input:focus,
    a:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* LightGallery toolbar styling */
    .lg-toolbar {
      top: auto !important;
      bottom: 0 !important;
      width: 100% !important;
      background: rgba(0,0,0,0.6) !important;
      justify-content: center !important;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .lg-outer:hover .lg-toolbar,
    .lg-toolbar:hover {
      opacity: 1 !important;
    }
    .lg-icon {
      color: #fff !important;
    }
    
    /* Fallback icons for LightGallery if CSS fails to load */
    .lg-close::before {
      content: "✕" !important;
      font-family: Arial, sans-serif !important;
      font-size: 24px !important;
      line-height: 1 !important;
    }
    .lg-prev::before {
      content: "‹" !important;
      font-family: Arial, sans-serif !important;
      font-size: 32px !important;
      line-height: 1 !important;
    }
    .lg-next::before {
      content: "›" !important;
      font-family: Arial, sans-serif !important;
      font-size: 32px !important;
      line-height: 1 !important;
    }
    .lg-play::before {
      content: "▶" !important;
      font-family: Arial, sans-serif !important;
      font-size: 20px !important;
      line-height: 1 !important;
    }
    .lg-pause::before {
      content: "⏸" !important;
      font-family: Arial, sans-serif !important;
      font-size: 20px !important;
      line-height: 1 !important;
    }

    nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      position: sticky;
      top: 0;
      background: white;
      border-bottom: 1px solid #ddd;
      z-index: 100;
    }
    body.dark-mode nav {
      background: #2a2a2a;
      border-color: #444;
    }
    nav a {
      font-family: 'Playfair Display', serif;
      text-decoration: none;
      color: #555;
      font-size: 1.1em;
    }
    body.dark-mode nav a {
      color: #ccc;
    }
    nav a:hover {
      color: var(--accent);
    }
    #theme-toggle {
      margin-left: auto;
      background: none;
      border: none;
      font-size: 1.3em;
      cursor: pointer;
    }

    h1, h2, h3 {
      font-family: 'Playfair Display', serif;
      text-align: center;
    }
    .upload-section,
    .gallery-section {
      max-width: 1000px;
      margin: auto;
      padding: 40px 20px;
    }
    .upload-box {
      text-align: center;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: background 0.3s, box-shadow 0.3s;
    }
    body.dark-mode .upload-box {
      background: #2a2a2a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .upload-box p {
      margin: 10px 0 20px;
      color: #555;
    }
    body.dark-mode .upload-box p {
      color: #aaa;
    }
    #upload-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 1em;
      border-radius: 8px;
      cursor: pointer;
    }

    #gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    #gallery-grid div {
      position: relative;
    }
    #gallery-grid img {
      width: 100%;
      border-radius: 8px;
      transition: transform 0.3s ease;
      display: block;
    }
    #gallery-grid img:hover {
      transform: scale(1.03);
    }
    .skeleton {
      filter: blur(5px);
      background: #ddd;
    }
    .download-btn {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      padding: 4px 6px;
      font-size: 0.9em;
      border-radius: 4px;
      cursor: pointer;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 10px 20px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
    }

    footer {
      text-align: center;
      padding: 40px;
      background: var(--text);
      color: var(--bg);
      font-size: 0.95em;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode footer {
      background: var(--text);
      color: var(--bg);
    }
    footer a {
      color: #fff;
      text-decoration: underline;
    }

    /* Access gate overlay */
    .access-gate {
      position: fixed;
      inset: 0;
      background: rgba(249, 247, 243, 0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .access-gate[hidden] { display: none; }
    .gate-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 24px;
      width: min(480px, 92vw);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      text-align: center;
    }
    .gate-title {
      font-family: 'Playfair Display', serif;
      color: #778053;
      margin: 0 0 12px;
    }
    .gate-input-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      justify-content: center;
    }
    .gate-input {
      flex: 1;
      max-width: 260px;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    .gate-button {
      background: #C9486A;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }
    .gate-button:focus { outline: 2px solid #C9486A; outline-offset: 2px; }
    .gate-error {
      color: #b00020;
      font-size: 0.95rem;
      margin-top: 10px;
    }
    .gate-help {
      font-size: 0.9rem;
      color: #666;
      margin-top: 12px;
    }
    body.gate-active { overflow: hidden; }
  </style>

  <!-- LightGallery core + autoplay plugin -->
  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/lightgallery.umd.min.js" onerror="console.error('LightGallery core script failed to load')"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/plugins/autoplay/lg-autoplay.umd.min.js" onerror="console.error('LightGallery autoplay plugin failed to load')"></script>
  <script>const lgAutoplay = window.lgAutoplay;</script>

  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
</head>
<body>

  <!-- Access Gate Overlay (shown only if not previously granted) -->
  <div id="access-gate" class="access-gate" role="dialog" aria-modal="true" aria-labelledby="gate-title" hidden>
    <div class="gate-card">
      <h2 id="gate-title" class="gate-title">Enter access code</h2>
      <div class="gate-input-row">
        <input id="gate-input" class="gate-input" type="password" inputmode="text" autocomplete="off" placeholder="Access code" aria-label="Enter access code" />
        <button id="gate-submit" class="gate-button">Enter</button>
      </div>
      <p id="gate-error" class="gate-error" aria-live="polite" hidden>Incorrect code, please try again.</p>
      <p class="gate-help">Already opened the invitation? Use the same code.</p>
    </div>
  </div>

  <nav>
    <a href="index.html">Invitation</a>
    <a href="#upload">Upload</a>
    <a href="#gallery">Gallery</a>
    <a href="gifts.html">Gifts</a>
    <button id="theme-toggle">🌙</button>
  </nav>

  <section id="upload" class="upload-section">
    <div class="upload-box">
      <h2>Share Your Favourite Moments</h2>
      <p>Upload your photos from the evening — we’d love to see your memories.</p>
      <button id="upload-btn">Upload Your Photo</button>
    </div>
  </section>

  <section id="gallery" class="gallery-section">
    <h2>Gallery</h2>
    <p style="text-align:center;color:#555;">
      A growing collection of shared moments and highlights.
    </p>
    <div id="gallery-grid">
      <!-- Cloudinary images + download overlays go here -->
    </div>
  </section>

  <footer>
    Want to add more? Upload as many as you like, or email us at 
    <a href="mailto:invite@jamesandoliver.com">invite@jamesandoliver.com</a>.
  </footer>

  <div id="toast" class="toast"></div>

  <script>
    // your Cloudinary & LightGallery config
    const CLOUD_NAME    = 'dh8f8hnhe';
    const UPLOAD_PRESET = 'guest_upload';
    const TAG_NAME      = 'gallery';
    


    document.addEventListener('DOMContentLoaded', () => {
      // Lightweight access gate using the same code as the main invitation page
      const gate = document.getElementById('access-gate');
      const input = document.getElementById('gate-input');
      const submit = document.getElementById('gate-submit');
      const errorEl = document.getElementById('gate-error');

      function showGate() {
        if (gate) {
          gate.hidden = false;
          document.body.classList.add('gate-active');
          setTimeout(() => { input && input.focus(); }, 0);
        }
      }

      function hideGate() {
        if (gate) {
          gate.hidden = true;
          document.body.classList.remove('gate-active');
        }
      }

      function validate() {
        const code = (input?.value || '').trim().toLowerCase();
        const encodedPassword = btoa('celebratejando').split('').reverse().join('');
        const userInput = btoa(code).split('').reverse().join('');
        if (userInput === encodedPassword) {
          try { localStorage.setItem('accessGranted', 'true'); } catch (_) {}
          hideGate();
          return true;
        } else {
          if (errorEl) errorEl.hidden = false;
          if (input) {
            input.value = '';
            input.focus();
          }
          return false;
        }
      }

      // If access not yet granted, show gate and wire events
      try {
        if (localStorage.getItem('accessGranted') !== 'true') {
          showGate();
          submit?.addEventListener('click', validate);
          input?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              validate();
            }
          });
        }
      } catch (_) {
        // If localStorage unavailable, still show gate
        showGate();
        submit?.addEventListener('click', validate);
        input?.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') { e.preventDefault(); validate(); }
        });
      }

      // theme toggle
      const toggle = document.getElementById('theme-toggle');
      const applyTheme = dark => {
        document.body.classList.toggle('dark-mode', dark);
        localStorage.setItem('darkMode', dark);
        toggle.textContent = dark ? '☀️' : '🌙';
      };
      toggle.addEventListener('click', () => applyTheme(!document.body.classList.contains('dark-mode')));
      applyTheme(localStorage.getItem('darkMode') === 'true');

      // LightGallery init
      const galleryEl = document.getElementById('gallery-grid');
      let lg = null;
      
      function initLightGallery() {
        if (lg) {
          lg.destroy();
        }
        
        if (typeof lightGallery !== 'undefined') {
          lg = lightGallery(galleryEl, {
            selector: 'div > a',
            plugins: [lgAutoplay],
            controls: true,
            autoplay: false,
            autoplayControls: true,
            speed: 500,
            pause: 5000,
            download: false,
            counter: true,
            showThumbByDefault: false
          });
        }
      }
      
      // Initialize gallery after a short delay
      setTimeout(initLightGallery, 100);

      // helper UI
      const seen = new Set();
      const toast = document.getElementById('toast');
      function showToast(msg) {
        toast.textContent = msg;
        toast.style.opacity = 1;
        setTimeout(() => toast.style.opacity = 0, 2000);
      }

      function renderImage(res, prepend = false) {
        const url = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/f_auto,q_auto/v${res.version}/${res.public_id}.${res.format}`;
        const wrapper = document.createElement('div');
        wrapper.style.position = 'relative';

        // LightGallery anchor
        const link = document.createElement('a');
        link.href = url;
        const img = document.createElement('img');
        img.src     = url;
        img.alt     = 'Shared memory';
        img.loading = 'lazy';
        img.classList.add('skeleton');
        img.onload  = () => {
          img.classList.remove('skeleton');
          // Track image load analytics
          if (typeof gtag !== 'undefined') {
            gtag('event', 'image_loaded', {
              event_category: 'Gallery',
              event_label: 'photo_viewed'
            });
          }
        };
        link.appendChild(img);
        wrapper.appendChild(link);

        // download overlay
        const dl = document.createElement('button');
        dl.className = 'download-btn';
        dl.textContent = '⤓';
        dl.title = 'Download original';
        dl.addEventListener('click', e => {
          e.stopPropagation();
          const a = document.createElement('a');
          a.href     = url;
          a.download = `${res.public_id}.${res.format}`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          showToast('Download started');
        });
        wrapper.appendChild(dl);

        if (prepend) galleryEl.prepend(wrapper);
        else         galleryEl.appendChild(wrapper);

        // Refresh gallery after adding new images
        setTimeout(() => {
          if (lg) {
            lg.refresh();
          }
        }, 100);
      }

      // initial load
      fetch(`https://res.cloudinary.com/${CLOUD_NAME}/image/list/${TAG_NAME}.json`)
        .then(r => r.json())
        .then(data => {
          data.resources
            .sort((a,b) => b.version - a.version)
            .forEach(res => {
              seen.add(res.asset_id);
              renderImage(res);
            });
          // Refresh gallery after initial load
          setTimeout(() => {
            if (lg) {
              lg.refresh();
            }
          }, 200);
        })
        .catch(console.error);

      // live polling
      setInterval(() => {
        fetch(`https://res.cloudinary.com/${CLOUD_NAME}/image/list/${TAG_NAME}.json`)
          .then(r => r.json())
          .then(data => {
            let added = false;
            data.resources
              .sort((a,b) => b.version - a.version)
              .forEach(res => {
                if (!seen.has(res.asset_id)) {
                  seen.add(res.asset_id);
                  renderImage(res, true);
                  added = true;
                }
              });
            if (added) {
              setTimeout(() => {
                if (lg) {
                  lg.refresh();
                }
              }, 100);
            }
          })
          .catch(console.error);
      }, 30000);

      // Simplified Cloudinary upload widget - following the working test pattern
      let widget = null;
      
      // Create widget after a short delay to ensure everything is loaded
      setTimeout(() => {
        if (typeof cloudinary !== 'undefined' && typeof cloudinary.createUploadWidget === 'function') {
          try {
            widget = cloudinary.createUploadWidget({
              cloudName: CLOUD_NAME,
              uploadPreset: UPLOAD_PRESET,
              tags: [TAG_NAME],
              sources: ['local', 'camera'],
              multiple: true,
              showAdvancedOptions: false,
              cropping: false,
              showPoweredBy: false
            }, (error, result) => {
              if (error) {
                console.error('Upload error:', error);
                showToast('Upload failed. Please try again.');
              } else if (result.event === 'success') {
                seen.add(result.info.asset_id);
                renderImage(result.info, true);
                showToast('Photo uploaded successfully!');
                
                // Track successful upload analytics
                if (typeof gtag !== 'undefined') {
                  gtag('event', 'photo_uploaded', {
                    event_category: 'Gallery',
                    event_label: 'upload_success',
                    custom_parameter_1: 'photo_upload'
                  });
                }
              }
            });
            
            console.log('Cloudinary widget created successfully');
          } catch (error) {
            console.error('Failed to create Cloudinary widget:', error);
          }
        } else {
          console.error('Cloudinary not available for widget creation');
        }
      }, 500);

      // Simple upload button handler
      document.getElementById('upload-btn').addEventListener('click', () => {
        if (widget) {
          widget.open();
        } else {
          console.error('Widget not initialized');
          showToast('Upload widget not available. Please refresh the page.');
        }
      });
    });
  </script>
</body>
</html>